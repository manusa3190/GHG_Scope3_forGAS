<script lang="ts">
export default defineComponent({
  components:{Detail},
    setup(){

      const form = useForm({
        validationSchema: yup.object({
          在庫単位あたり重量:yup.number().when("必要_在庫単位あたり重量", {
            is: true,
            then:()=>yup.number().positive('0より大きい数値にしてください')
            // then:(shema)=> shema.number().positive('0より大きい数値にしてください') // この書き方はTypescript
          }),
          使用単位あたり重量:yup.number().when("必要_在庫単位あたり重量", {
            is: true,
            then:()=>yup.number().positive('0より大きい数値にしてください')
          }),
          // 種別コード: yup.string(),
          容リ法分類:yup.string().required('選択してください'),
          容リ法商品業種:yup.string().required('必須です').when('容リ法分類',{
            is:'対象外',
            then:()=>yup.string().oneOf(['対象外'],'容リ法分類が対象外なら、商品業種も対象外にしてください'),
            otherwise:()=>yup.string().oneOf(['食料品','清涼飲料等','酒類','油脂加工等','医薬品','化粧品等','小売業','その他'],'当該資材を使用している製品の業種を選んでください')
          }),
          プラスチックフラグ:yup.boolean(),
          製法コード:yup.string(),
          組成: yup.array().min(1,'最低一つは選んでください').of(yup.object({
            IDEA製品コード:yup.string().required('IDEA製品を選んでください'),
            使用量: yup.number().positive('使用量は正の数にしてください').required()
          }))
        })
      })

      var grid

      onMounted(()=>{

        const columns = [
          {id:'品目コード',name:'品目コード',width:'130px'},
          {id:'品名', name:'品名', width:'250px'},
          {id:'取引先名', name:'取引先名', width:'150px'},
          {id:'担当者名', name:'担当者名', formatter: (cell, row) => cell? html(`<div>${cell}</div>`):html(`<div>担当者なし</div>`)},
          {id:'構成コード',hidden:true},
          {id:'構成コード',name:'登録',formatter: (cell, row) => cell? html(`<div>済</div>`):html(`<div></div>`)}
        ]

        grid = new Grid({
          columns,
          data:filtered自所属原資材items.value ,
          className:{
            th:'!p-1 text-center',
            td:'max-w-52 truncate !bg-inherit !py-0.5 text-center'
          },
          height:'800px',
          sort:true,
          fixedHeader:true,
          pagenation:{limit:30}
        })

        grid.on('rowClick',(...args)=>{
          const {cells } = args[1]
          const 品目コード = cells[columns.findIndex(c=>c==='品目コード'||c.id==='品目コード')].data
          const item = useTables().自所属原資材docs[品目コード]
          form.setValues(item)

          changeSelectedRowColor()

          useState().$patch({isEdit:!item['構成コード']})
        })

        grid.render(document.getElementById('index'))
      })

      function changeSelectedRowColor(){
          const rowElems = document.querySelectorAll('.gridjs-tr');

          rowElems.forEach(row => {
            const idElem = row.firstElementChild
            const id = idElem.innerText
            const isSelected = id == form.values['品目コード']

            row.classList.toggle('bg-orange-100', isSelected)
          });
      }

      const save = form.handleSubmit( async values=>{
          useState().$patch({isLoading:true})

          const {currentUser} = useUsers()
          values['作成者メールアドレス'] = currentUser['メールアドレス']
          values['作成者所属名'] = currentUser['所属名']
          console.log('サーバーに送るデータ:',values)

          await useTables().sync自所属原資材docs(values)

          grid.updateConfig({data:filtered自所属原資材items.value})
          grid.forceRender()

          useState().$patch({isLoading:false})
        })

      const query = reactive({
        onlyMyItems:true,
        onlyIncomplete:false
      })

      const filtered自所属原資材items = computed(()=>{
          let items = Object.values(useTables().自所属原資材docs)

          if(query.onlyMyItems){
            items = items.filter(item=>item['担当者メールアドレス']===currentUserEmail.innerText)
          }
          if(query.onlyIncomplete){
            items = items.filter(item=>!item['構成コード'])
          }

          return items
      })

      watch(filtered自所属原資材items,()=>{
        if(!grid)return

        grid.updateConfig({data:filtered自所属原資材items.value})
        grid.forceRender()
      })

      return {form, save, query}
  }
})

</script>

<template>
  <div class="flex justify-between h-full w-screen">
    <!-- 左側 -->
    <div>
      <div class="flex gap-4">
        <label class=" label max-w-44 cursor-pointer">
          <input type="checkbox" class="checkbox checkbox-xs" v-model="query.onlyMyItems" />
          <span class="label-text">自分の担当品目のみ</span> 
        </label>

        <label class=" label max-w-44 cursor-pointer">
          <input type="checkbox" class="checkbox checkbox-xs" v-model="query.onlyIncomplete" />
          <span class="label-text">未完了の品目のみ</span> 
        </label>
      </div>

      <table id="index" class=" border table table-sm w-[500px]" />
    </div>

    <!-- 右側ウィンドウ -->
    <div class="bg-orange-100 h-full w-96 flex-none p-3">
      <div v-if="!Object.keys(form.values).length" class="">原資材を選んでください</div>

      <div v-else class="flex flex-col">
        <Detail :form="form" @save="save" />
      </div>
    </div>
  </div>
  
</template>