<script lang="ts">

export default defineComponent({
  props:{form:Object},
  setup(props){
    const {form} = props
    const {handleSubmit, values, errors, meta, setValues} = form

    const 構成名 = ref('')

    const 種別マスタdocs = useMasters()

    const dialog = ref(null)

    function record(){
      if(!構成名.value){
        alert('構成名をつけてください')
        return
      }

      const item = {
        ...values,
        構成名:構成名.value,
        使いまわし:true
      }

      google.script.run
        .withSuccessHandler( async res=>{
          alert(`登録しました ${res}`)
          const {fetch自所属原資材docs, fetch使いまわし情報docs}= useTables()
          await Promise.all([fetch自所属原資材docs(),fetch使いまわし情報docs()])
          
          dialog.value.close()
        })
        .set情報and構成(item)
      
    }

    return {構成名, 種別マスタdocs, values, dialog, record }
  }
})

</script>

<template>
    
    <div v-if="values['使いまわし']"> {{ values['構成名'] }}で構成登録されています</div>
    <button v-else class=" link" @click="dialog.showModal()">この構成を登録</button>

    <dialog class="modal" ref="dialog">
    <div class="modal-box">
        <h3 class="font-bold text-lg">この構成を登録します</h3>

        <label>
          <span>わかりやすい名前をつけてください</span>
          <input class="input input-sm input-bordered w-96" v-model="構成名" placeholder="ブルーレット詰め替え台紙_精英堂">          
        </label>

        <div class=" border m-2 p-2 flex flex-col space-y-3">
            <div class=" card-title">構成情報</div>

            <p>種別:{{ 種別マスタdocs[values['種別コード']]}}</p>
            <p>容リ法分類:{{values['容リ法分類']}}</p>
            <p>プラスチックフラグ:{{values['プラスチックフラグ']}}</p>

            <table class="table table-sm">
              <thead><tr>
                <td>IDEA製品コード</td><td>IDEA製品名</td><td>使用量</td>
              </tr></thead>

              <tbody>
                <tr v-for="item of values['組成']">
                  <td>{{item['IDEA製品コード']}}</td><td>{{item['IDEA製品名']}}</td><td>{{item['使用量']+ item['使用量単位']}}</td>
                </tr>
              </tbody>
            </table>

        </div>

        <div class="modal-action space-x-3">
            <button class="btn btn-primary" @click="record">登録</button>
            <button class="btn" @click="dialog.close()">閉じる</button>
        </div>
    </div>
    </dialog>
</template>