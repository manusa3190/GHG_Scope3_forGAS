<script lang="ts">
import { defineComponent, computed } from 'vue'
import {useRoute} from 'vue-router'
import useMasters from '@/stores/useMasters'
import useState from '@/stores/useState'

import RecordSpec from '@/components/RecordSpec.vue'
import SelectSpec from '@/components/SelectSpec.vue'
import Form種別 from '@/components/Form種別.vue'
import Form容リ法 from '@/components/Form容リ法.vue'
import Form製法 from '@/components/Form製法.vue'
import Form組成 from '@/components/Form組成.vue'
import FormNumber from '@/components/FormNumber.vue'
import Form仕様名 from '@/components/Form仕様名.vue'


export default defineComponent({
  components:{
    RecordSpec,SelectSpec,
    Form種別,Form容リ法, Form製法, Form組成, Form仕様名,FormNumber, ItemsOfThe仕様
  },
  props:{form:Object},
  setup(props,{emit}){
    const route = useRoute()

    const {form} = props
    const {handleSubmit, values, errors, meta, setValues} = form

    const {種別マスタdocs} = useMasters()

    const canEdit = computed(()=>{
      switch(route.name){
        case '仕様管理':
          return values['使いまわし']
        case '一覧':
          return !values['使いまわし']
      }
    })

    return {handleSubmit, errors, meta, values, setValues, useState, 種別マスタdocs, canEdit}
  }
})

</script>

<template>
  <div class="space-y-8 prose">

    <div>
      <Form仕様名 v-if="$route.name==='仕様管理'" />

      <div v-if="$route.name==='一覧'" class="tooltip" :data-tip="values['品名']">
        <div class=" truncate max-w-80 font-bold text-2xl">{{ values['品名'] }}</div>
      </div>

    </div>

    <div class="flex">
        <div v-if="$route.name==='一覧'">

            <div v-if="!canEdit">
              <div class="text-xs">この品目の仕様は他品目でも使用されています</div>
              <a class="link text-sm block" @click="$router.push({path:'/spec',query:{仕様コード:values['仕様コード']}})">
                編集（仕様管理に飛びます）
              </a>
              <a class="link text-sm block" @click="setValues({仕様コード: null,仕様名: values['品名'] + '_仕様',使いまわし: false})">共通仕様を外す</a>

            </div>

            <RecordSpec v-if="values['仕様コード'] && !values['使いまわし']" :form="form" />
            <SelectSpec v-if="!values['仕様コード']" :form="form" />          
        </div>


        <div class="flex-1"></div>
        <button v-if="!canEdit && !meta.dirty" class="btn btn-primary">編集</button>
        <button v-if="meta.dirty" class=" btn btn-primary" :disabled="!meta.valid" @click="$emit('save')">保存</button>

        <button class="btn btn-ghost" onclick="debug_modal.showModal()">・・・</button>
        <dialog id="debug_modal" class="modal">
          <div class="modal-box">
            <pre>values:{{values}}</pre>

            <pre>errors:{{errors}}</pre>

            <pre>dirty:{{meta.dirty}}, valid:{{meta.valid}}</pre>
          </div>

          <form method="dialog" class="modal-backdrop"><button>close</button></form>
        </dialog>

    </div>

    <ItemsOfThe仕様 v-if="$route.name==='仕様管理'" />

    <Form種別 :canEdit="canEdit" :setValues="setValues"/>

    <Form容リ法 :canEdit="canEdit"/>
  
    <div>
      <h2>排出量計算用情報</h2>
      
      <div v-if="values['種別コード'] && 種別マスタdocs[values['種別コード']]['必要_在庫単位あたり重量']" class="">
        <p class="text-xs">樹脂成型品や個箱など、1個あたりの重量が必要なもの</p>

        <div class="pl-6">
            <FormNumber v-if="!values['在庫単位名'].includes('グラム')" name="在庫単位あたり重量" :suffix="'g/'+values.在庫単位名" :canEdit="canEdit"></FormNumber>
            <FormNumber name="使用単位あたり重量" suffix="g/ケ" :canEdit="canEdit"></FormNumber>
        </div>
      </div>
 
      <div v-if="values['種別コード']==='alcohols'">
        <p>アルコールはIDEA原単位がLなので、比重が必要</p>
        <FormNumber name="比重" suffix="kg/L" :canEdit="canEdit"></FormNumber>
      </div>
    </div>

    <Form組成 :canEdit="canEdit" :種別選択済="!!values['種別コード']"
    :errors="Object.entries(errors).filter(([k,v])=>k.startsWith('組成'))"/>

    <Form製法 :canEdit="canEdit"/>

  </div>
</template>