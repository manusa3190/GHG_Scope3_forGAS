<script>

export default defineComponent({
  setup(){
    const router = useRouter()
    const routes = router.getRoutes()

    router.beforeEach(async(to, from) => {
      if(!useState().initialized){
        useState().$patch({isLoading:true})

        try{
          await Promise.all([
            useTables().sync自所属原資材docs(null),
            useTables().sync構成docs(null),
            useMasters().syncMasters(),
            useUsers().get自所属users(null)
          ])
        }catch(err){
          alert(`データ同期中にエラーが発生しました。ページリロードを試してください。${err}`)
        }

        useState().$patch({initialized:true})
        useState().$patch({isLoading:false})          
      } 
    })

    return { routes, useUsers, useState }
  }
})

</script>

<template>
<div class="drawer ">
  <input id="main-drawer" type="checkbox" class="drawer-toggle" />
  
  <div class="drawer-content flex flex-col items-center justify-center">
    <!-- Page content here -->
    <nav class="w-full navbar bg-base-300">
      <div class="flex-none">
        <label for="main-drawer" aria-label="open sidebar" class="btn btn-square btn-ghost">
          <svg fill="none" viewBox="0 0 24 24" class="inline-block stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </label>
      </div>

      <h1 class="flex-1 px-2 mx-2 text-2xl font-bold">{{ $route.name }}</h1>

      <div>{{ useUsers().currentUser? useUsers().currentUser.従業員名 : 'sample@kisatsu.com'}}でログイン中</div>
    </nav>

    <div v-if="useState().isLoading" class="w-screen h-screen flex flex-col justify-center items-center fixed top-0 bg-black bg-opacity-30 z-50">
        <span class="loading loading-spinner loading-lg"></span>
    </div>

    <RouterView v-slot="{ Component }">
      <template v-if="Component">
        <Suspense>
          <main class="text-sm w-full">
            <component :is="Component"></component>         
          </main>
        </Suspense>
      </template >
    </RouterView>
  
  </div>

  <div class="drawer-side">
    <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label> 
    <ul class="menu p-4 w-56 min-h-full bg-base-200 text-lg font-semibold text-base-content">
      <!-- Sidebar content here -->
      <li v-for="r of routes" :key="r.path">
        <RouterLink :to="r.path">{{r.name}}</RouterLink>
      </li>
    </ul>
  
  </div>
</div>
</template>